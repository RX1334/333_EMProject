<!DOCTYPE html>
<html>
    <head>
        <title>Energy Monitoring</title>
        <link rel="stylesheet" href="../static/emp.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
          href="https://fonts.googleapis.com/css2?family=Public+Sans&display=swap"
          rel="stylesheet"
        />
        <!-- Importing JQuery at beginning for use in everything else -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <!-- Importing d3.js at the beginning for use in data visualizations -->
        <script src="https://d3js.org/d3.v4.min.js"></script>
    </head>
    <body>
        <div class="center-screen">
            <div id="dashboard">
                <!-- Content is shucked into here via AJAX requests, dynamically per page -->
                {{dashboard_content|safe}}
            </div>
        </div>
    </body>
    <script>
        "use strict";

        let request = null;

        function handle_fumehood_data(response) {
            for (const [key, value] of Object.entries(response)) {
                $("#fumehood" + key).text(value + " kW");
            }
        }

        function get_fumehood_data() {
            let url = "/fumehood_stuff";
            if (request != null) request.abort();

            request = $.ajax({
                type: "GET",
                url: url,
                success: handle_fumehood_data,
            });
        }

        function handle_rerender(response) {
            $('#dashboard').html(response)
            $('.activate_rabinowitz_icahn_201').on('click', lab_summary);
        }

        function dashboard() {
            let url = "/";
            if (request != null) request.abort();

            request = $.ajax({
                type: "GET",
                url: url,
                success: handle_rerender,
            });
        }

        function lab_summary() {
            let url = "/lab_summary?lab_name=rabinowitz_icahn_201";
            if (request != null) request.abort();

            request = $.ajax({
                type: "GET",
                url: url,
                success: handle_rerender,
            });
        }

        // --------------------------------------------------------
        // Real time data fetching code
        // --------------------------------------------------------

        // Change to url params in the future
        const labNames = ['rabinowitz_icahn_201']
        const fumehoodId = 'fumehood0'

        // get fumehood # from url params
        // const queryString = window.location.search;
        // const urlParams = new URLSearchParams(queryString);
        // const fumehoodId = urlParams.get('fumehood_id')


        function handle_rt_resp(response) {
            for (const [key, value] of Object.entries(response)) {

                // color fumehood open status the correct color

                if (key.endsWith("-mini-status")) {
                    $("#" + key).children("span").text(value)
                    if (value == "CLOSED") {
                        $("#" + key).children("span").addClass("green")
                        $("#" + key).children("span").removeClass("red")
                        $("#" + key).children("img").attr("src","../static/images/GreenDot.svg");
                    } else {
                        $("#" + key).children("span").addClass("red")
                        $("#" + key).children("span").removeClass("green")
                        $("#" + key).children("img").attr("src","../static/images/RedDot.svg");
                    }
                    continue;
                }
                if (key.endsWith("-status")) {
                    if (value == "OPEN") {
                        $("#" + key).addClass("red")
                        $("#" + key).removeClass("green")
                    }
                    else {
                        $("#" + key).addClass("green")
                        $("#" + key).removeClass("red")
                    }
                }

                // shunt in the correct value into the html
                $("#" + key).text(value);
            }
        }

        function get_rt_data() {
            labNames.forEach((labName) => {
                let url = "/real_time_data?lab_name=" + labName
                url += '&fumehood_id=' + fumehoodId
                request = $.ajax({
                    type: "GET",
                    url: url,
                    success: handle_rt_resp,
                });
            })
        }

        function setup() {
            get_rt_data();
            window.setInterval(get_rt_data, 1000);
        }

        $("document").ready(setup);
    </script>
</html>